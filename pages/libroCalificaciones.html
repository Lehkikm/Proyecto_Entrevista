<h1>Libro de registro</h1>

<br/>
<!--Lista de estudiantes-->
<div class="row">
    <div class="col-md-6">
        <div class="dropdown" style="display:block">
            <button class="btn btn-default dropdown-toggle col-md-12" type="button" id="btn_listaEstudiantes" data-toggle="dropdown"
                aria-expanded="true">Escoger al estudiante
                <span class="caret"></span>
            </button>
            <ul id="ul_listaEstudiantes" class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">

            </ul>
        </div>
    </div>
</div>

<br/>
<br/>

<div class="table-responsive">

    <table id="tbl_libroCalificaciones" style="font-size:0.8em" class="table table-condensed">

        <thead>
            <tr>
                <th>Septiembre</th>
                <th>Octubre</th>
                <th>Noviembre</th>
            </tr>
        </theah>

        <tbody>
            <td>
                <input type="text" class="input-calificacion" id="txt_septiembre"> &nbsp;
                <button id="btn_septiembre" class="btn-comentario" data-toggle="modal" data-target="#myModal">Comentario</button>
            </td>
            <td>
                <input type="text" class="input-calificacion" id="txt_octubre"> &nbsp;
                <button id="btn_octubre" class="btn-comentario data-toggle="modal" data-target="#myModal"">Comentario</button>
            </td>
            <td>
                <input type="text" class="input-calificacion" id="txt_noviembre"> &nbsp;
                <button id="btn_noviembre" class="btn-comentario" data-toggle="modal" data-target="#myModal">Comentario</button>
            </td>
        </tbody>
    </table>

    <!-- Modal -->
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
    
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Agregar comentario</h4>
                </div>
                <div class="modal-body" style="margin-bottom: 10px;">
                    <textarea name="comentario" id="text_comentario" class="col-md-12" rows="10" value=""></textarea>

                    <button class="btn btn-primary" style="margin-top: 20px;">Guardar comentario</button>
                </div>
                <div class="modal-footer">
                </div>
            </div>
    
        </div>
    </div>

</div>

<button id="btn_aplicarCambios" class="btn btn-primary" style="margin-top: 20px;">Modificar calificaci칩n</button>

<script>
    asistenteFirebase.detectaUsuario(ofreceListaEstudiantesRegistrados);

    var idEstudiante = null;
    
    var ref = asistenteFirebase.getRaizRef();
    function ofreceListaEstudiantesRegistrados() {
        //Obteniendo referencia
            emailUsuarioActual = AsistenteFirebase.emailUsuarioActual().replace(".", "_"),
            estudiantesRef = ref.child("Estudiantes");

        //Escuchando todos los cambios y almacenando los registros
        estudiantesRef.on("value", function (snapshot) {
            var estudiantes = snapshot.val(),
                ul_listaEstudiantes = $("#ul_listaEstudiantes");

            //A침adiendo propiedades y valores a los elementos creados.
            for (estudiante in estudiantes) {
                var a_estudiante = $("<a>", {
                    role: "menuitem",
                    tabindex: "-1",
                    href: "#",
                    value: estudiantes[estudiante].cedula,
                    onclick: "cambiaNombreBoton(this)",
                    id: estudiante
                });

                /*<li role="presentation"><a role="menuitem" tabindex="-1" href="#">O +</a></li>*/
                var li_estudiante = $("<li>", { role: "presentation" });

                a_estudiante.text(estudiantes[estudiante].nombre + " (" + estudiantes[estudiante].matricula + ")");
                li_estudiante.append(a_estudiante);
                ul_listaEstudiantes.append(li_estudiante);

                console.log(a_estudiante.text());
            }
        });
    }

    function cambiaNombreBoton(penlace) { //Ejecutado cuando le das a un enlace del dropdown
        $("#btn_listaEstudiantes").text($(penlace).text());
        console.log($(penlace).attr('value'));
        cedula = $(penlace).attr('value');
        idEstudiante = $(penlace).attr('id');

        console.log(idEstudiante);
    }

    function modificaCalificacion(calificacion){
        // 1. Obtener id del estudiante
        // 2. Aplicar update por medio de una funci칩n firebase.
        var idEstudiante = idEstudiante //Obteniendo el id del paciente de la fila donde se encuentra el bot칩n
        var estudiantesRef = ref
    }

    $("#btn_aplicarCambios").click(function(){
        var calificacion = {
            noviembre: $("#txt_septiembre").val(),
            septiembre:$("#txt_octubre").val(),
            octubre: $("#txt_noviembre").val()
        }

        var comentario = {
            septiembre : $("#text_comentario").val(),
            octubre: $("#text_comentario").val(),
            noviembre: $("#text_comentario").val(),
        }

        var ref = asistenteFirebase.getRaizRef(),
            estudiantesRef = ref.child("Estudiantes");
        
        estudiantesRef.child(idEstudiante).update({
            calificacion: calificacion

        });

        console.log(calificacion);
    });

    $(".btn-comentario").click(function(){
        $("textarea[name='comentario']").attr("id", $("#btn_septiembre").attr("id") + idEstudiante);
        var idComentario = $("#text_comentario").attr("id");
        console.log(idComentario);
    })

</script>